# 工业产品缺陷检测系统

一个基于 Flask, OpenCV 和 PyTorch 的工业产品缺陷检测系统。系统提供了友好的 Web 界面，支持实时视频和图片缺陷检测。

## 功能

- 模型管理（上传、选择、加载）
- 实时视频缺陷检测
- 图片上传检测
- 缺陷类型统计
- 检测结果导出
- 用户管理（管理员/普通用户权限分离）
- AI智能分析（基于DeepSeek视觉模型）
- 管理控制台（系统管理与数据统计）

## 安装步骤

1. 克隆仓库

```bash
git clone <repository-url>
cd <repository-directory>
```

2. 创建虚拟环境（可选但推荐）

```bash
python -m venv venv
source venv/bin/activate  # 在 Windows 上使用: venv\Scripts\activate
```

3. 安装依赖

```bash
pip install -r requirements.txt
```

## 运行应用

```bash
python app.py
```

应用将运行在 http://localhost:5000

## 用户管理系统

系统实现了基于角色的访问控制，包含两种用户角色：

### 用户角色

1. **管理员（Admin）**
   - 拥有系统的完全控制权
   - 可以管理所有用户账户
   - 可以上传和管理检测模型
   - 可以配置系统参数
   - 可以查看所有检测历史和统计数据
   - 可以访问管理控制台

2. **普通用户（User）**
   - 可以使用已加载的模型进行检测
   - 可以上传图片进行分析
   - 可以查看自己的检测历史
   - 无法修改系统设置和模型

### 注册和认证流程

1. **注册流程**
   - 新用户通过 `/register` 页面注册账号
   - 填写用户名、密码和邮箱
   - 系统发送验证邮件到注册邮箱
   - 用户点击验证链接激活账号
   - 初始注册的用户默认为普通用户角色

2. **管理员指定**
   - 系统初始化时会创建一个默认管理员账号
   - 已有管理员可以在用户管理界面提升普通用户为管理员

3. **登录认证**
   - 用户通过 `/login` 页面登录系统
   - 支持记住登录状态
   - 支持密码重置功能

### 用户相关API

- `/api/auth/register` - 用户注册
- `/api/auth/login` - 用户登录
- `/api/auth/logout` - 用户登出
- `/api/users` - 获取用户列表（仅管理员）
- `/api/users/{id}` - 获取/修改/删除特定用户（仅管理员）
- `/api/profile` - 获取/修改当前用户资料

## 管理控制台

系统提供了功能完善的管理控制台，仅管理员可访问，包括：

### 仪表盘
- 系统关键数据统计（用户数、检测数、分析数、缺陷数）
- 最近7天检测数据图表
- 缺陷类型分布图表
- 最近活动记录

### 用户管理
- 用户列表查看
- 添加新用户
- 编辑用户信息和权限
- 删除用户
- 用户搜索功能

### 检测记录管理
- 所有用户的检测记录查看
- 按日期筛选
- 详情查看
- 一键AI分析

### 分析记录管理
- AI分析记录查看
- 按日期筛选
- 详情查看

### 系统设置
- 检测参数设置（置信度阈值、最大结果数、自动分析）
- API设置（DeepSeek API密钥等）
- 邮件系统设置
- 数据库维护（备份、优化、清除记录）

## 目录结构

应用会自动创建以下目录：

- `models/`: 存储上传的模型文件
- `uploads/`: 存储上传的图片
- `results/`: 存储处理后的图片和导出的数据
- `database/`: 存储用户数据和系统配置

## 注意事项

当前版本使用了模拟的检测功能。如需使用实际的检测模型，请修改 `detect_defects` 函数。

## 系统要求

- Python 3.8+
- 建议配置 GPU 以获得更好的检测性能

## 技术栈

- 后端: Flask, OpenCV, PyTorch, SQLAlchemy
- 前端: Bootstrap, ECharts, JavaScript
- 数据库: SQLite (开发) / PostgreSQL (生产) 